<!DOCTYPE html>
<html>
    <head>
        <script type = "text/javascript" src = "//d3js.org/d3.v4.min.js"></script>
        <link rel="stylesheet" href="styles.css">
    </head>
    <body>
    
    <div id="graph"></div>
    <script>

        var margin = {top: 20, right: 30, bottom: 20, left: 30}
        var width = 300
        var height = 300
        var thickness = 50


        function myfun(str){
            var mylist = str.split("-");
            var x = Number(mylist[0])
            var y = Number(mylist[1])
            return Array(x,y)
        }
        var svg = d3.select("#graph")
            .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
            .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");
    
        d3.json("data/graph.json", function(data) {
            // x axis
            var x = d3.scaleLinear()
                .domain([1, d3.max(data.nodes, d=>d.epoch)])
                .range([margin.left, width-margin.right-40])
                .interpolate(d3.interpolateRound);
            
            // y axis
            var y = d3.scaleLinear()
                .domain([1, d3.max(data.nodes, d=>d.id)])
                .range([height-margin.bottom, margin.top])
                .interpolate(d3.interpolateRound)

            // node scale
            var color = d3.scaleSequential()
                .domain([0, d3.max(data.nodes, d => d.size)])
                .interpolator(d3.interpolateViridis)
            
            // edge thick
            var thick = d3.scaleLinear()
                .domain([0, d3.max(data.edges, d => d.w)])
                .range([thickness, 1, thickness])

             // tooltips
            var edgeTooltip = d3.select("#graph")
                .append("div")
                    .style("position", "absolute")
                    .style("visibility", "hidden")
                    
            var edgeMouseover = function(d) {
                edgeTooltip.style("visibility", "visible")
                    .html(d.w)
                      .style("left", d3.event.pageX+10 + "px")
                      .style("top", d3.event.pageY + "px")
            }
            var edgeMouseout = function(d) {
                edgeTooltip.transition()
                    .delay(1000)
                    .style("visibility", "hidden")
            }

            var nodeTooltip = d3.select("#graph")
                .append("div")
                    .style("position", "absolute")
                    .style("visibility", "hidden")

            var nodeMousemove = function(d) {
                nodeTooltip.style("visibility", "visible")
                    .html(d.topn)
                      .style("left", d3.event.pageX+10 + "px")
                      .style("top", d3.event.pageY + "px")
                      .style("background-color", "white")
                      .style("border", "solid")
                      .style("border-width", "2px")
                      .style("border-radius", "5px")
                    d3.select(this)
                    .style("stroke", "black")
                    .style("opacity", 1)
            }

            var nodeMouseout = function(d) {
                nodeTooltip.transition()
                    .delay(100)
                    .style("visibility", "hidden")
            }

            // edges   
            var edge = svg.append("g")
            .selectAll("edges")
            .data(data.edges)
            .enter()
            .append("line")
                .attr("x1", d=>x(myfun(d.s)[0]))
                .attr("y1", d=>y(myfun(d.s)[1]))
                .attr("x2", d=>x(myfun(d.t)[0]))
                .attr("y2", d=>y(myfun(d.t)[1]))
                .attr("stroke-with", d=>thick(d.w))
                .style("stroke", "#999")
            .on("mouseover", d=>edgeMouseover(d))
            .on("mouseout", d=>edgeMouseout(d))

            // nodes
            var node = svg.append("g")
            .selectAll("nodes")
            .data(data.nodes)
            .enter()
            .append("circle")
                .attr("cx", d=>x(d.epoch))
                .attr("cy", d=>y(d.id))
                .attr("r", 10)
                .attr("stroke", "black")
                .attr("stroke-width", 2)
                .style("fill", d=>color(d.size))
                .style("opacity", 1.0)
            //.on("mouseover", d=>nodeMouseover(d))
            .on("mousemove", d=>nodeMousemove(d))
            .on("mouseout", d=>nodeMouseout(d))
            
            // legend

            // y axis bar
            var yBar = d3
                .scaleLinear()
                .domain([0, d3.max(data.nodes, d => d.size)])
                .range([height, 0])

            var lastEpoch = Math.max.apply(null, data.nodes.map(d=>d.epoch));
            
            // array with n elements equi-spaced between [start, end]
            function linspaceArray(start, end, n) {
                var arr = [];
                var step = (end - start) / (n - 1);
                for (var i = 0; i < n; i++) {
                    arr.push(start + (step * i));
                }
            return arr;
            }
            var mydata = linspaceArray(0, 1, 1000)
           
            var legend = svg.append("g")
            .selectAll("rect")
            .data(mydata)
            .enter()
            .append("rect")
                .attr("x", x(lastEpoch)+20)
                .attr("y", d=>yBar(d))
                .attr("width", 20)
                .attr("height", 1)
                .style("fill", d=>color(d))
            var ticksPosition = x(lastEpoch)+40
            var ticks = svg.append("g")
            .attr("transform", "translate("+ticksPosition+","+0+")")  
            .call(d3.axisRight(yBar)
            .tickFormat(function(d){
                return d;
            }).ticks(5))
            .append("text")
            //.attr("transform", "rotate(90)")
                // .attr("x", x(lastEpoch)+40)
                // .attr("y", d=>yBar(d))
            //.attr("dy", "5.1em")
            //.attr("text-anchor", "end")
            //.attr("stroke", "black")
            //.text("Topic Size");
    })
    
    </script>
  
    </body>
</html>